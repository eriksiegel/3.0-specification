buildscript {
  repositories {
    maven { url '/tmp/repo' }
    mavenCentral()
    maven { url "http://maven.restlet.org" }
  }

  dependencies {
    classpath group: 'org.docbook', name: 'docbook-xslt2', version: '2.1.2'
    classpath group: 'com.xmlcalabash', name: 'xmlcalabash1-print', version: '1.1.4'
    classpath group: 'com.xmlcalabash', name: 'xmlcalabash1-gradle', version: '1.2.2'
  }
}

plugins {
  id "de.undercouch.download" version "2.0.0"
}

repositories {
  mavenLocal()
  mavenCentral()
}

configurations {
  tools {
    description = "Run tools"
    transitive = true
  }
}

dependencies {
  tools (
    fileTree(dir: 'tools/lib').include("*.jar")
  )
}

defaultTasks 'allspecs'

apply plugin: 'org.docbook.task'
apply plugin: 'com.xmlcalabash.task'
apply plugin: 'groovy'

import org.docbook.DocBookTask
import com.xmlcalabash.XMLCalabashTask
import de.undercouch.gradle.tasks.download.Download

project.ext.docbookXslt = "docbook-xslt2-$docbookXsltVersion"

// ================================================================================

task allspecs() {
  // dependencies are added by the specs
}

task xproc(dependsOn: [ "setupDocBook", "xproc_schemas", "spec_schemas",
                        "xproc:specification", "xproc_assets", "xproc_src" ],
             type: XMLCalabashTask) {
  inputs.file "xproc/build/source.xml"
  inputs.file "tools/xsl/docbook.xsl"
  inputs.file "tools/xsl/dbspec.xsl"
  inputs.file "tools/xsl/xprocns.xsl"
  inputs.file "tools/xsl/ml-macro.xsl"
  inputs.file "tools/xsl/rngsyntax.xsl"
  inputs.file "tools/xpl/formatspec.xpl"
  outputs.file "build/dist/xproc/index.html"
  input("source", "xproc/build/source.xml")
  output("result", "build/dist/xproc/index.html")

  param("schemaext.schema", "build/schema/dbspec.rng")
  param("xml.toc.filename", "build/xproc.toc.xml")
  param("spec", "xproc")
  option("style", "../../tools/xsl/xproc-specs.xsl")
  pipeline "tools/xpl/formatspec.xpl"
}
allspecs.dependsOn "xproc"

task xproc_assets(dependsOn: [ "xproc_web_assets" ], type: Copy) {
  from "xproc/build/graphics"
  into "build/dist/xproc/graphics/"
}

task xproc_web_assets(type: Copy) {
  from "src/main/resources"
  into "build/dist/xproc/"
}

task xproc_src(dependsOn: ["xproc:source"], type: Copy) {
  from "xproc/build/"
  into "build/dist/xproc/"
  include "source.xml"
  rename ("source.xml", "specification.xml")
}

// ======================================================================
// overview

task overview(dependsOn: [ "setupDocBook", "xproc_schemas", "spec_schemas",
                           "overview:specification", "overview_assets",
                           "overview_src" ],
              type: XMLCalabashTask) {
  inputs.file "overview/build/source.xml"
  inputs.file "tools/xsl/docbook.xsl"
  inputs.file "tools/xsl/dbspec.xsl"
  inputs.file "tools/xsl/xprocns.xsl"
  inputs.file "tools/xsl/ml-macro.xsl"
  inputs.file "tools/xsl/rngsyntax.xsl"
  inputs.file "tools/xpl/formatspec.xpl"
  outputs.file "build/dist/index.html"
  input("source", "overview/build/source.xml")
  output("result", "build/dist/index.html")

  param("schemaext.schema", "build/schema/dbspec.rng")
  param("xml.toc.filename", "build/xproc.toc.xml")
  param("spec", "xproc")
  option("style", "../../tools/xsl/xproc-specs.xsl")
  pipeline "tools/xpl/formatspec.xpl"
}
allspecs.dependsOn "overview"

task overview_assets(type: Copy) {
  from "src/main/resources"
  into "build/dist/"
}

task overview_src(dependsOn: ["overview:source"], type: Copy) {
  from "overview/build/"
  into "build/dist/"
  include "source.xml"
  rename ("source.xml", "specification.xml")
}

// ======================================================================
// steps-intro

// This step didn't run if it was named 'steps_intro'. ¯\_(ツ)_/¯?
task steps_intro_x(dependsOn: [ "setupDocBook", "xproc_schemas", "spec_schemas",
                                "steps-intro:specification", "steps_intro_assets",
                                "steps_intro_src" ],
                 type: XMLCalabashTask) {
  inputs.file "steps-intro/build/source.xml"
  inputs.file "tools/xsl/docbook.xsl"
  inputs.file "tools/xsl/dbspec.xsl"
  inputs.file "tools/xsl/xprocns.xsl"
  inputs.file "tools/xsl/ml-macro.xsl"
  inputs.file "tools/xsl/rngsyntax.xsl"
  inputs.file "tools/xpl/formatspec.xpl"
  outputs.file "build/dist/steps-intro/index.html"
  input("source", "steps-intro/build/source.xml")
  output("result", "build/dist/steps-intro/index.html")

  param("schemaext.schema", "build/schema/dbspec.rng")
  param("xml.toc.filename", "build/xproc.toc.xml")
  param("spec", "xproc")
  option("style", "../../tools/xsl/xproc-specs.xsl")
  pipeline "tools/xpl/formatspec.xpl"
}
allspecs.dependsOn "steps_intro_x"

task steps_intro_assets(type: Copy) {
  from "src/main/resources"
  into "build/dist/steps-intro/"
}

task steps_intro_src(dependsOn: ["steps-intro:source"], type: Copy) {
  from "steps-intro/build/"
  into "build/dist/steps-intro/"
  include "source.xml"
  rename ("source.xml", "specification.xml")
}

// ======================================================================
// steps

task steps(dependsOn: [ "setupDocBook", "xproc_schemas", "spec_schemas",
                        "steps:specification", "steps_assets", "steps_src",
                        "steps_xpl" ],
           type: XMLCalabashTask) {
  inputs.file "steps/build/source.xml"
  inputs.file "tools/xsl/docbook.xsl"
  inputs.file "tools/xsl/dbspec.xsl"
  inputs.file "tools/xsl/xprocns.xsl"
  inputs.file "tools/xsl/ml-macro.xsl"
  inputs.file "tools/xsl/rngsyntax.xsl"
  inputs.file "tools/xpl/formatspec.xpl"
  outputs.file "build/dist/steps/index.html"
  input("source", "steps/build/source.xml")
  output("result", "build/dist/steps/index.html")

  param("schemaext.schema", "build/schema/dbspec.rng")
  param("xml.toc.filename", "build/xproc.toc.xml")
  param("spec", "xproc")
  option("style", "../../tools/xsl/xproc-specs.xsl")
  pipeline "tools/xpl/formatspec.xpl"
}
allspecs.dependsOn "steps"

task steps_assets(type: Copy) {
  from "src/main/resources"
  into "build/dist/steps/"
}

task steps_src(dependsOn: ["steps:source"], type: Copy) {
  from "steps/build/"
  into "build/dist/steps/"
  include "source.xml"
  rename ("source.xml", "specification.xml")
}

task steps_xpl(dependsOn: ["steps:library"], type: Copy) {
  from "steps/build/"
  into "build/dist/steps/"
  include "library.xml"
  rename ("library.xml", "steps.xpl")
}

// ======================================================================
// step-validate-relax-ng

task validate_relax_ng(dependsOn: [ "setupDocBook", "xproc_schemas", "spec_schemas",
                                    "step-validate-relax-ng:specification",
                                    "validate_relax_ng_assets",
                                    "validate_relax_ng_src", "validate_relax_ng_xpl" ],
                       type: XMLCalabashTask) {
  inputs.file "step-validate-relax-ng/build/source.xml"
  inputs.file "tools/xsl/docbook.xsl"
  inputs.file "tools/xsl/dbspec.xsl"
  inputs.file "tools/xsl/xproc-specs.xsl"
  inputs.file "tools/xsl/xprocns.xsl"
  inputs.file "tools/xsl/ml-macro.xsl"
  inputs.file "tools/xsl/rngsyntax.xsl"
  inputs.file "tools/xpl/formatspec.xpl"
  outputs.file "build/dist/validate-with-relax-ng/index.html"
  input("source", "step-validate-relax-ng/build/source.xml")
  output("result", "build/dist/validate-with-relax-ng/index.html")

  param("schemaext.schema", "build/schema/dbspec.rng")
  param("xml.toc.filename", "build/xproc.toc.xml")
  param("spec", "xproc")
  option("style", "../../tools/xsl/xproc-specs.xsl")
  pipeline "tools/xpl/formatspec.xpl"
}
allspecs.dependsOn "validate_relax_ng"

task validate_relax_ng_assets(type: Copy) {
  from "src/main/resources"
  into "build/dist/validate-with-relax-ng/"
}

task validate_relax_ng_src(dependsOn: ["step-validate-relax-ng:source"], type: Copy) {
  from "step-validate-relax-ng/build/"
  into "build/dist/validate-with-relax-ng/"
  include "source.xml"
  rename ("source.xml", "specification.xml")
}

task validate_relax_ng_xpl(dependsOn: ["step-validate-relax-ng:library"], type: Copy) {
  from "step-validate-relax-ng/build/"
  into "build/dist/validate-with-relax-ng/"
  include "library.xml"
  rename ("library.xml", "steps.xpl")
}

// ======================================================================
// step-validate-xml-schema

task validate_xml_schema(dependsOn: [ "setupDocBook", "xproc_schemas", "spec_schemas",
                                      "step-validate-xml-schema:specification",
                                      "validate_xml_schema_assets",
                                      "validate_xml_schema_src", "validate_xml_schema_xpl"],
                         type: XMLCalabashTask) {
  inputs.file "step-validate-xml-schema/build/source.xml"
  inputs.file "tools/xsl/docbook.xsl"
  inputs.file "tools/xsl/dbspec.xsl"
  inputs.file "tools/xsl/xproc-specs.xsl"
  inputs.file "tools/xsl/xprocns.xsl"
  inputs.file "tools/xsl/ml-macro.xsl"
  inputs.file "tools/xsl/rngsyntax.xsl"
  inputs.file "tools/xpl/formatspec.xpl"
  outputs.file "build/dist/validate-with-xml-schema/index.html"
  input("source", "step-validate-xml-schema/build/source.xml")
  output("result", "build/dist/validate-with-xml-schema/index.html")

  param("schemaext.schema", "build/schema/dbspec.rng")
  param("xml.toc.filename", "build/xproc.toc.xml")
  param("spec", "xproc")
  option("style", "../../tools/xsl/xproc-specs.xsl")
  pipeline "tools/xpl/formatspec.xpl"
}
allspecs.dependsOn "validate_xml_schema"

task validate_xml_schema_assets(type: Copy) {
  from "src/main/resources"
  into "build/dist/validate-with-xml-schema/"
}

task validate_xml_schema_src(dependsOn: ["step-validate-xml-schema:source"], type: Copy) {
  from "step-validate-xml-schema/build/"
  into "build/dist/validate-with-xml-schema/"
  include "source.xml"
  rename ("source.xml", "specification.xml")
}

task validate_xml_schema_xpl(dependsOn: ["step-validate-xml-schema:library"], type: Copy) {
  from "step-validate-xml-schema/build/"
  into "build/dist/validate-with-xml-schema/"
  include "library.xml"
  rename ("library.xml", "steps.xpl")
}

// ======================================================================
// step-validate-schematron

task validate_schematron(dependsOn: [ "setupDocBook", "xproc_schemas", "spec_schemas",
                                      "step-validate-schematron:specification",
                                      "validate_schematron_assets",
                                      "validate_schematron_src","validate_schematron_xpl" ],
                         type: XMLCalabashTask) {
  inputs.file "step-validate-schematron/build/source.xml"
  inputs.file "tools/xsl/docbook.xsl"
  inputs.file "tools/xsl/dbspec.xsl"
  inputs.file "tools/xsl/xproc-specs.xsl"
  inputs.file "tools/xsl/xprocns.xsl"
  inputs.file "tools/xsl/ml-macro.xsl"
  inputs.file "tools/xsl/rngsyntax.xsl"
  inputs.file "tools/xpl/formatspec.xpl"
  outputs.file "build/dist/validate-with-schematron/index.html"
  input("source", "step-validate-schematron/build/source.xml")
  output("result", "build/dist/validate-with-schematron/index.html")

  param("schemaext.schema", "build/schema/dbspec.rng")
  param("xml.toc.filename", "build/xproc.toc.xml")
  param("spec", "xproc")
  option("style", "../../tools/xsl/xproc-specs.xsl")
  pipeline "tools/xpl/formatspec.xpl"
}
allspecs.dependsOn "validate_schematron"

task validate_schematron_assets(type: Copy) {
  from "src/main/resources"
  into "build/dist/validate-with-schematron/"
}

task validate_schematron_src(dependsOn: ["step-validate-schematron:source"], type: Copy) {
  from "step-validate-schematron/build/"
  into "build/dist/validate-with-schematron/"
  include "source.xml"
  rename ("source.xml", "specification.xml")
}

task validate_schematron_xpl(dependsOn: ["step-validate-schematron:library"], type: Copy) {
  from "step-validate-schematron/build/"
  into "build/dist/validate-with-schematron/"
  include "library.xml"
  rename ("library.xml", "steps.xpl")
}

// ======================================================================
// Specification schemas

task spec_schemas(dependsOn: [ "spec_rng", "spec_sch" ]) {
  // nop
}

task spec_rng(type: JavaExec) {
  classpath = configurations.tools
  main = 'com.thaiopensource.relaxng.translate.Driver'
  args = ["schema/dbspec.rnc", "build/schema/dbspec.rng"]
}
spec_rng.doFirst {
  mkdir("build/schema")
}

task spec_sch(type: Copy) {
  from('schema') {
    include "docbook.sch"
  }
  into "build/schema"
}

// ======================================================================
// XProc schemas

task core_rng(type: JavaExec) {
  classpath = configurations.tools
  main = 'com.thaiopensource.relaxng.translate.Driver'
  args = ["src/main/schema/xproc.rnc", "build/core.rng"]
}
core_rng.doFirst {
  mkdir("build")
}

task xproc_rng(dependsOn: [ "core_rng",
                            "steps:rng", "step-validate-relax-ng:rng",
                            "step-validate-xml-schema:rng",
                            "step-validate-schematron:rng" ],
               type: XMLCalabashTask) {
  inputs.file "build/core.rng"
  inputs.file "steps/build/library.xml"
  inputs.file "step-validate-relax-ng/build/library.xml"
  inputs.file "step-validate-xml-schema/build/library.xml"
  inputs.file "step-validate-schematron/build/library.xml"
  inputs.file "tools/xpl/make-rng.xpl"
  inputs.file "tools/xsl/make-rng.xsl"
  outputs.file "build/xproc.rng"
  input("source", "build/core.rng")
  output("result", "build/xproc.rng")
  pipeline "tools/xpl/make-rng.xpl"
}

task xproc_rnc(dependsOn: [ "xproc_rng" ], type: JavaExec) {
  classpath = configurations.tools
  main = 'com.thaiopensource.relaxng.translate.Driver'
  args = ["build/xproc.rng", "build/xproc.rnc"]
}
xproc_rnc.doFirst {
  mkdir("build")
}

task xproc_schemas(dependsOn: [ "xproc_rnc", "xproc_rng" ]) {
  // nop
}

// ================================================================================
// Setup DocBook

task downloadDocBook(type: Download) {
  src docbookXsltBaseUri + '/release/' + docbookXsltVersion + '/' + docbookXslt + '.zip'
  dest new File(buildDir, docbookXslt + '.zip')
}
downloadDocBook.onlyIf {
  !file("build/${docbookXslt}.zip").exists()
}

task setupDocBook(dependsOn: downloadDocBook, type: Copy) {
  from zipTree(downloadDocBook.dest)
  into { "build" }
  doLast {
    copy {
      from "build/$docbookXslt"
      into 'build/docbook'
    }
  }
}
setupDocBook.onlyIf { !file("build/docbook").exists() }

// ======================================================================
// Clean up

clean {
  doFirst {
    delete("build")
  }
}

